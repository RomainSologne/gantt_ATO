<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Planning des vols</title>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

  <!-- ArcGIS JS API -->
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    body { font-family: Arial; margin: 20px; }
    #chart { width: 100%; height: 100%; }
  </style>
</head>
<body>

<div id="chart"></div>

<script>
require(["esri/layers/FeatureLayer"], function(FeatureLayer) {

  const layer = new FeatureLayer({
    url: "https://services.arcgis.com/d3voDfTFbHOCRwVR/arcgis/rest/services/survey123_52a2c2c243354b4bbe1285638d3e41ba/FeatureServer/0",
    outFields: ["*"]
  });

  let rawTasks = []; // toutes les donn√©es AGO
  let filteredTasks = []; // donn√©es filtr√©es

  //------------------------------------------------------
  // üî• Charger les donn√©es AGO
  //------------------------------------------------------
  async function loadData() {
    const response = await layer.queryFeatures({
      where: "1=1",
      outFields: ["*"],
      returnGeometry: false
    });

    const colorMap = {};
    const palette = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd",
                     "#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];
    let colorIndex = 0;

    rawTasks = response.features.map(f => {
      const a = f.attributes;

      if (!a.d_but_de_lactivit || !a.fin_de_lactivit) return null;

      // Assigner couleur par zone
      if (!colorMap[a.field_9]) {
        colorMap[a.field_9] = palette[colorIndex % palette.length];
        colorIndex++;
      }

      // Ic√¥ne validation
      let icon = " ‚åõ";
      if (["Valid√©e", "valide", "OK"].includes(a.validation)) icon = " ‚úîÔ∏è";
      if (["Annul√©e", "KO"].includes(a.validation)) icon = " ‚ùå";

      return {
        Task: a.unit,
        Start: new Date(a.d_but_de_lactivit),
        Finish: new Date(a.fin_de_lactivit),
        Color: colorMap[a.field_9],
        Label: a.num_ro_de_mission + icon,
        Zone: a.field_9,
        Validation: a.validation
      };
    }).filter(t => t !== null);

    buildFilterOptions();  // (unit√©s + zones)
    applyFilters();        // lancement automatique
  }

  //------------------------------------------------------
  // üî• Construire les options des filtres (unit & zone)
  //------------------------------------------------------
  function buildFilterOptions() {
    const unitSel = document.getElementById("filterUnit");
    const zoneSel = document.getElementById("filterZone");

    const units = [...new Set(rawTasks.map(t => t.Task))].sort();
    const zones = [...new Set(rawTasks.map(t => t.Zone))].sort();

    unitSel.innerHTML = `<option value="">Toutes</option>` +
                        units.map(u => `<option value="${u}">${u}</option>`).join("");

    zoneSel.innerHTML = `<option value="">Toutes</option>` +
                        zones.map(z => `<option value="${z}">${z}</option>`).join("");
  }

  //------------------------------------------------------
  // üî• Appliquer les filtres
  //------------------------------------------------------
  function applyFilters() {
    const fs = document.getElementById("filterStart").value;
    const fe = document.getElementById("filterEnd").value;
    const fu = document.getElementById("filterUnit").value;
    const fz = document.getElementById("filterZone").value;

    filteredTasks = rawTasks.filter(t => {
      let ok = true;

      if (fs) ok = ok && t.Finish >= new Date(fs);
      if (fe) ok = ok && t.Start <= new Date(fe);
      if (fu) ok = ok && t.Task === fu;
      if (fz) ok = ok && t.Zone === fz;

      return ok;
    });

    updateChart(filteredTasks);
  }

  //------------------------------------------------------
  // üî• Dessiner le graphique
  //------------------------------------------------------
  function updateChart(tasks) {
    const now = new Date();

    const fig = {
      data: [{
        type: 'bar',
        x: tasks.map(t => t.Finish - t.Start),
        y: tasks.map(t => t.Task),
        base: tasks.map(t => t.Start),
        orientation: 'h',

        text: tasks.map(t => t.Label),

        customdata: tasks.map(t => ({
          start: t.Start,
          finish: t.Finish,
          zone: t.Zone,
          validation: t.Validation
        })),

        marker: { color: tasks.map(t => t.Color) },
        width: 0.4,

        hovertemplate:
          "<b>Mission %{text}</b><br>" +
          "Zone : %{customdata.zone}<br>" +
          "D√©but : %{customdata.start|%d/%m/%Y %H:%M}<br>" +
          "Fin : %{customdata.finish|%d/%m/%Y %H:%M}<br>" +
          "<extra></extra>"
      }],

      layout: {
        title: "Planification des vols",
        xaxis: { type: "date" },
        height: 450,
        margin: { l: 50, r: 20, t: 40, b: 40 },

        shapes: [{
          type: "line",
          x0: now, x1: now,
          y0: 0, y1: 1,
          xref: "x", yref: "paper",
          line: { color: "red", width: 2, dash: "dot" }
        }]
      }
    };

    Plotly.react("chart", fig);
  }

  //------------------------------------------------------
  // üî• Ajout des listeners sur les filtres
  //------------------------------------------------------
  document.getElementById("filterStart").onchange = applyFilters;
  document.getElementById("filterEnd").onchange = applyFilters;
  document.getElementById("filterUnit").onchange = applyFilters;
  document.getElementById("filterZone").onchange = applyFilters;

  //------------------------------------------------------
  // üî• Premier chargement
  //------------------------------------------------------
  loadData();

  //------------------------------------------------------
  // üî• Mise √† jour toutes les minutes
  //------------------------------------------------------
  setInterval(() => {
    console.log("‚ü≥ Mise √† jour AGO + filtre‚Ä¶");
    loadData();
  }, 60000);

});
</script>

</body>
</html>
