<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Planning des vols</title>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

  <!-- ArcGIS JS API -->
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    body { font-family: Arial; margin: 20px; }
    #chart { width: 100%; height: 100%; }
  </style>
</head>
<body>

<div id="chart"></div>

<script>
require(["esri/layers/FeatureLayer"], function(FeatureLayer) {

  const layer = new FeatureLayer({
    url: "https://services.arcgis.com/d3voDfTFbHOCRwVR/arcgis/rest/services/survey123_52a2c2c243354b4bbe1285638d3e41ba/FeatureServer/0",
    outFields: ["*"]
  });

  // -----------------------------------------------------
  // ðŸ”¥ Fonction qui construit et affiche le graphique
  // -----------------------------------------------------
  function updateChart(tasks) {

    const now = new Date();

    const fig = {
      data: [{
        type: 'bar',
        x: tasks.map(t => t.Finish - t.Start),
        y: tasks.map(t => t.Task),
        base: tasks.map(t => t.Start),
        orientation: 'h',
        text: tasks.map(t => t.Label),

        customdata: tasks.map(t => ({
          start: t.Start,
          finish: t.Finish,
          zone: t.Zone,
          validation: t.Validation
        })),

        width: 0.4,
        marker: { color: tasks.map(t => t.Color) },

        hovertemplate:
          "<b>Mission %{text}</b><br>" +
          "Zone : %{customdata.zone}<br>" +
          "DÃ©but : %{customdata.start|%d/%m/%Y %H:%M}<br>" +
          "Fin : %{customdata.finish|%d/%m/%Y %H:%M}<br>" +
          "<extra></extra>"
      }],

      layout: {
        title: "Planification des vols",
        xaxis: { type: "date" },
        height: 400,
        margin: { l: 50, r: 20, t: 40, b: 40 },

        // ðŸ”¥ FIL ROUGE recalculÃ© Ã  chaque update
        shapes: [{
          type: "line",
          x0: now,
          x1: now,
          y0: 0,
          y1: 1,
          xref: "x",
          yref: "paper",
          line: {
            color: "red",
            width: 2,
            dash: "dot"
          }
        }]
      }
    };

    Plotly.react("chart", fig);  // <<< react() = met Ã  jour sans recrÃ©er
  }

  // -----------------------------------------------------
  // ðŸ”¥ Charger les donnÃ©es ArcGIS UNE SEULE FOIS
  // -----------------------------------------------------
  layer.queryFeatures({
    where: "1=1",
    outFields: ["*"],
    returnGeometry: false
  }).then(response => {

    // ----- Construire la liste des tÃ¢ches une fois -----
    const colorMap = {};
    const palette = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];
    let colorIndex = 0;

    const tasks = response.features.map(f => {
      const attrs = f.attributes;

      const start = attrs.d_but_de_lactivit;
      const end = attrs.fin_de_lactivit;
      const unit = attrs.unit;
      const field9 = attrs.field_9;
      const missionNum = attrs.num_ro_de_mission;
      const validation = attrs.validation;

      if (!start || !end) return null;

      if (!colorMap[field9]) {
        colorMap[field9] = palette[colorIndex % palette.length];
        colorIndex++;
      }

      let icon = "";
      if (validation === "ValidÃ©e" || validation === "valide" || validation === "OK") {
        icon = " âœ”ï¸";
      } else if (validation === "AnnulÃ©e" || validation === "non vale" || validation === "KO") {
        icon = " âŒ";
      } else {
        icon = " âŒ›";
      }

      return {
        Task: unit,
        Start: new Date(start),
        Finish: new Date(end),
        Color: colorMap[field9],
        Label: missionNum + icon,
        Zone: field9,
        Validation: validation
      };
    }).filter(t => t !== null);

    if (tasks.length === 0) return;

    // -----------------------------------------------------
    // ðŸ”¥ 1) Affichage initial du graphe
    // -----------------------------------------------------
    updateChart(tasks);

    // -----------------------------------------------------
    // ðŸ”¥ 2) Mise Ã  jour automatique toutes les minutes
    // -----------------------------------------------------
    setInterval(() => {
      updateChart(tasks);
    }, 60 * 1000); // toutes les 60 secondes

  })
  .catch(err => {
    alert("Erreur lors du chargement des donnÃ©es : " + err);
  });

});
</script>

</body>
</html>
