<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Gantt Plotly + Feature Layer AGO</title>

  <!-- ArcGIS API for JavaScript -->
  <script src="https://js.arcgis.com/4.29/"></script>

  <!-- Plotly 2.x (AMD compatible) -->
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

  <style>
    html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
    #chart { width: 100%; height: 100vh; }
  </style>
</head>

<body>
  <div id="chart"></div>

  <script>
    require(["esri/layers/FeatureLayer"], function (FeatureLayer) {

      const featureLayerUrl =
        "https://services.arcgis.com/d3voDfTFbHOCRwVR/arcgis/rest/services/survey123_52a2c2c243354b4bbe1285638d3e41ba/FeatureServer/0";

      const layer = new FeatureLayer({ url: featureLayerUrl });

      const query = layer.createQuery();
      query.where = "1=1";
      query.outFields = ["d_but_de_lactivit", "fin_de_lactivit", "unit"];
      query.returnGeometry = false;

      layer.queryFeatures(query).then(function(result) {

        const tasks = result.features
          .map(f => {
            const start = f.attributes.d_but_de_lactivit;
            const end   = f.attributes.fin_de_lactivit;
            const unit  = f.attributes.unit;
            if (!start || !end) return null;
            return {
              Task: unit,
              Start: new Date(start),
              Finish: new Date(end)
            };
          })
          .filter(t => t !== null);

        // Préparer les données Plotly "timeline"
        const data = [{
          type: 'timeline',
          x: tasks.map(t => [t.Start, t.Finish]),
          y: tasks.map(t => t.Task),
          text: tasks.map(t => t.Task),
          hovertemplate:
            "<b>%{y}</b><br>Début: %{x[0]|%d/%m/%Y}<br>Fin: %{x[1]|%d/%m/%Y}<extra></extra>"
        }];

        const layout = {
          title: "Diagramme de Gantt — Feature Layer AGO",
          margin: { l: 150, r: 20, t: 40, b: 40 },
          yaxis: { automargin: true }
        };

        Plotly.newPlot("chart", data, layout);
      });

    });
  </script>

</body>
</html>
