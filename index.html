<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Debug Gantt</title>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <!-- ArcGIS JS API -->
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    body { font-family: Arial; margin: 20px; }
    #chart { width: 100%; height: 600px; }
    .log { background: #f5f5f5; padding: 10px; border-radius: 4px; margin-top: 20px; }
  </style>
</head>
<body>

<h2>Debug ‚Äì Gantt depuis FeatureLayer</h2>

<div id="chart"></div>

<div class="log">
  <strong>Console :</strong> Ouvre F12 ‚Üí onglet "Console" pour voir les logs d√©taill√©s.
</div>

<script>
require([
  "esri/layers/FeatureLayer"
], function(FeatureLayer) {

  console.log("‚û°Ô∏è D√©but du debug Gantt");

  const layer = new FeatureLayer({
    url: "https://services.arcgis.com/d3voDfTFbHOCRwVR/arcgis/rest/services/survey123_52a2c2c243354b4bbe1285638d3e41ba/FeatureServer/0",
    outFields: ["*"]
  });

  layer.queryFeatures({
    where: "1=1",
    outFields: ["*"],
    returnGeometry: false
  }).then(response => {
    console.log("üìå Nombre d'entit√©s retourn√©es :", response.features.length);

    const tasks = response.features.map(f => {
      const attrs = f.attributes;

      console.log("--- Entit√© ---");
      console.log("start :", attrs.d_but_de_lactivit);
      console.log("end   :", attrs.fin_de_lactivit);
      console.log("unit  :", attrs.unit);

      if (!attrs.d_but_de_lactivit || !attrs.fin_de_lactivit) {
        console.warn("‚ö†Ô∏è Entit√© ignor√©e car dates manquantes");
        return null;
      }

      return {
        Task: attrs.unit,
        Start: new Date(attrs.d_but_de_lactivit),
        Finish: new Date(attrs.fin_de_lactivit)
      };
    }).filter(t => t !== null);

    console.log("üìå T√¢ches valides :", tasks.length);

    if (tasks.length === 0) {
      console.error("‚ùå Aucune t√¢che valide ‚Üí Gantt vide.");
      return;
    }

    const fig = {
      data: [{
        type: 'bar',
        x: tasks.map(t => t.Finish - t.Start),
        y: tasks.map(t => t.Task),
        orientation: 'h',
        base: tasks.map(t => t.Start),
      }],
      layout: {
        title: "Gantt Debug",
        xaxis: { type: "date" },
        height: 600
      }
    };

    Plotly.newPlot('chart', fig);
  })
  .catch(err => {
    console.error("‚ùå Erreur queryFeatures :", err);
  });

});
</script>

</body>
</html>
